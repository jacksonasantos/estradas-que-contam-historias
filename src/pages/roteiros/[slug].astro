---
import BaseLayout from "../../layouts/BaseLayout.astro";
import roteiros from "../../data/roteiros";
import { CATEGORIAS } from "../../data/categorias";

/* üîë OBRIGAT√ìRIO PARA ROTAS DIN√ÇMICAS */
export async function getStaticPaths() {
  return roteiros.map((roteiro) => ({
    params: { slug: roteiro.slug },
  }));
}

const { slug } = Astro.params;
const roteiro = roteiros.find(r => r.slug === slug);
const categoria = CATEGORIAS.find(c => c.id === roteiro?.categoria);
const iconPath = categoria?.icon;
if (!roteiro) {
  throw new Error(`Roteiro n√£o encontrado: ${slug}`);
}
---

{roteiro ? (
  <BaseLayout title={`${roteiro.titulo} | Estradas que Contam Hist√≥rias`}>
    <div class="flex items-center justify-between px-6 md:px-16 pt-2 pb-2">
      <div></div>
      <a
        href="#"
        onclick="history.back(); return false;"
        class="flex items-center gap-2 border border-neutral-700 px-4 py-2 rounded-full hover:border-neutral-400 hover:text-white transition text-base ml-auto"
      >
        ‚Üê<span class="hidden md:inline"> Voltar</span>
      </a>
    </div>
    <!-- HERO -->
    <section id="hero-section" class="relative h-[60vh] flex items-center justify-start" style="background-color: #f3f3f3;">
      <img
        src={roteiro.imagem}
        alt={roteiro.titulo}
        class="absolute inset-0 w-full h-full object-contain z-1"
        loading="lazy"
        id="hero-img"
        crossorigin="anonymous"
      />
    
      <div class="absolute inset-0 bg-linear-to-t from-black/80 via-black/30 to-transparent">
      </div>

      <div class="relative bg-neutral-800/80 z-10 px-6 pt-6 pb-6 max-w-3xl items-start">
        <span class="flex items-center gap-2 text-sm uppercase tracking-wider text-neutral-300 mb-3">
          {iconPath && (
            <img src={iconPath} alt={categoria?.label} width="32" height="32" class="inline-block align-middle" style="filter: invert(80%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(90%) contrast(90%);" />
          )}
          {categoria?.label}
        </span>
        
        <h1 class="text-4xl md:text-4xl font-serif text-white mb-4 text-center">
          {roteiro.titulo}
        </h1>

        <p class="text-lg text-neutral-300 max-w-2xl text-center">
          {roteiro.subtitulo}
        </p>
      </div>
    </section>

    <script is:inline>
    window.addEventListener("load", () => {
      const img = document.getElementById("hero-img");
      const section = document.getElementById("hero-section");

      if (!img || !section) return;

      function getAverageColor(image) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = image.naturalWidth;
        canvas.height = image.naturalHeight;

        ctx.drawImage(image, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        let r = 0, g = 0, b = 0;
        let count = 0;

        // Amostragem: pega 1 pixel a cada 20 para performance
        for (let i = 0; i < data.length; i += 80) {
          r += data[i];
          g += data[i + 1];
          b += data[i + 2];
          count++;
        }

        return [
          Math.floor(r / count),
          Math.floor(g / count),
          Math.floor(b / count)
        ];
      }

      function darken(color, amount = 60) {
        return color.map(c => Math.max(c - amount, 0));
      }

      function rgb(color, alpha = 1) {
        return `rgba(${color[0]}, ${color[1]}, ${color[2]}, ${alpha})`;
      }

      function applyCinematicBackground() {
        try {
          const avgColor = getAverageColor(img);
          const darkPrimary = darken(avgColor, 40);
          const darkSecondary = darken(avgColor, 80);

          const gradient = `
            radial-gradient(
              circle at 30% 30%,
              ${rgb(darkPrimary, 1)} 0%,
              transparent 90%
            ),
            linear-gradient(
              to bottom,
              ${rgb(darkPrimary, 1)} 0%,
              ${rgb(darkSecondary, 1)} 100%
            )
          `;

          section.style.background = gradient;

        } catch (error) {
          console.warn("Canvas error:", error);
          section.style.background = "#111";
        }
      }

      if (img.complete) {
        applyCinematicBackground();
      } else {
        img.addEventListener("load", applyCinematicBackground);
      }
    });
    </script>

    <!-- INFO R√ÅPIDA -->
    <section class="px-6 md:px-20 py-6 bg-neutral-950 border-t border-neutral-800">
      <ul class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center max-w-9xl">
        <li>
          <span class="label">Regi√£o</span><br />
          <span class="value">{roteiro.regiao}</span>
        </li>
        <li>
          <span class="label">Dist√¢ncia</span><br />
          <span class="value">{roteiro.distancia}</span>
        </li>
        <li>
          <span class="label">Dura√ß√£o</span><br />
          <span class="value">{roteiro.duracao}</span>
        </li>
        <li>
          <span class="label">N√≠vel</span><br />
          <span class="value">{roteiro.nivel}</span>
        </li>
        <li>
          <span class="label">Formato</span><br />
          <span class="value">{roteiro.tipo}</span>
        </li>
      </ul>
    </section>

    <!-- HIST√ìRIA -->
    <section class="px-6 md:px-20 py-12 max-w-9xl">
      {(roteiro.situacao === 0 || roteiro.situacao === 'Em Breve') && (
        <div class="flex justify-center mb-4">
          <span class="px-2 py-0.5 rounded bg-yellow-400 text-yellow-900 text-xl font-bold tracking-wide">
            EM BREVE
          </span>
        </div>
      )}
      <h2 class="section-title">A hist√≥ria da estrada</h2>
      <p class="section-text max-w-4xl whitespace-pre-line">
        {roteiro.historia}
      </p>
    </section>

    <!-- O CAMINHO + EXPERI√äNCIA -->
    <section class="px-6 md:px-20 py-12 border-t border-neutral-800 bg-neutral-950">
      <div class="grid md:grid-cols-2 gap-12 max-w-6xl mx-auto">
        <!-- O CAMINHO -->
        <div>
          <h2 class="section-title mb-8">O caminho</h2>
          <ol class="space-y-4 max-w-xl">
            {roteiro.caminho.map((ponto, index) => {
              // Divide o ponto em texto e mensagem extra (ap√≥s @)
              const [main, extra] = ponto.split("@");
              return (
                <li class="flex flex-col gap-1 items-start">
                  <div class="flex gap-4 items-start">
                    <span class="text-neutral-400 font-mono">
                      {index + 1}
                    </span>
                    <span class="text-neutral-300">
                      {main.trim()}
                    </span>
                  </div>
                  {extra && (
                    <span class="ml-8 text-sm text-neutral-400 italic">
                      {extra.trim()}
                    </span>
                  )}
                </li>
              );
            })}
          </ol>
        </div>
        <!-- EXPERI√äNCIA -->
        <div>
          <h2 class="section-title mb-8">O que esperar da viagem</h2>
          <ul class="list-disc pl-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
            {roteiro.experiencia.map(item => (
              <li class="text-neutral-300">
                {item}
              </li>
            ))}
          </ul>
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section class="px-6 md:px-20 py-12 bg-neutral-950 border-t border-neutral-800 text-center">
      <h2 class="text-3xl font-serif mb-6">
        Pronto para viver essa estrada?
      </h2>

      <p class="text-neutral-400 mb-8">
        Esse roteiro pode ser adaptado ao seu ritmo, estilo e moto.
      </p>

      <a
        href="/contato"
        class="inline-block px-8 py-4 rounded-full bg-white text-neutral-900 font-medium hover:scale-105 transition"
      >
        Fale sobre essa viagem
      </a>
    </section>

  </BaseLayout>
) : (
  <BaseLayout title="Roteiro n√£o encontrado | Estradas que Contam Hist√≥rias">
    <section class="px-6 md:px-20 py-24 text-center">
      <h1 class="text-4xl md:text-5xl font-serif mb-4">
        Roteiro n√£o encontrado
      </h1>
      <p class="text-lg text-neutral-300">
        O roteiro solicitado n√£o foi encontrado. Por favor, verifique o endere√ßo ou escolha outro roteiro.
      </p>
    </section>
  </BaseLayout>
)}