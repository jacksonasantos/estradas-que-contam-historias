---
import BaseLayout from "../layouts/BaseLayout.astro";
import conquistas from "../data/conquistas";
import CardConquista from "../components/CardConquista.astro";
import { CONQUISTAS_TIPO } from "../data/conquistas_tipo";

// Categorias √∫nicas
const tipos = [...new Set(conquistas.map(c => c.type))];

// Contagem por tipo
const contagem = tipos.map(type => ({
  id: type,
  label: CONQUISTAS_TIPO.find(t => t.id === type)?.label ?? type,
  icon: CONQUISTAS_TIPO.find(t => t.id === type)?.icon ?? "",
  total: conquistas.filter(c => c.type === type).length
}));

// Contagem por estado
const contagemEstado = [...new Set(conquistas.map(c => c.state))].map(state => ({
  id: state,
  label: state,
  total: conquistas.filter(c => c.state === state).length
}));

const totalConquistas = conquistas.length;
---

<BaseLayout title="Conquistas">
  <section class="px-6 md:px-20 py-12 max-w-9xl relative">
    <div>
      <div class="flex items-center mb-4">
        <h1 class="text-5xl font-serif mb-0">Conquistas</h1>
      </div>
      <p class="text-neutral-400 text-lg">
        Estradas, serras e lugares que marcam jornadas memor√°veis.
      </p>
    </div>
    <a
      href="#"
      onclick="history.back(); return false;"
      class="absolute right-6 md:right-60 top-12 flex items-center gap-2 border border-neutral-700 px-4 py-2 rounded-full hover:border-neutral-400 hover:text-white transition text-base"
        style="z-index:20;"
    >
      ‚Üê<span class="hidden md:inline"> Voltar</span>
    </a>
    <a href="/conquistas/mapa"
        class="absolute right-6 md:right-20 top-12 flex items-center gap-2 border border-neutral-700 px-4 py-2 rounded-full hover:border-neutral-400 hover:text-white transition text-base"
        style="z-index:10;"
    >
      üó∫Ô∏è<span class="hidden md:inline">Ver mapa</span>
    </a>
  </section>

  <!-- Filtros Tipo -->
  <section class="px-6 md:px-20 pb-1 ">
    <div id="filtros-conquistas" class="flex flex-wrap gap-4 gap-y-1 overflow-x-auto scrollbar-hide py-2">
      <!-- Todos -->
      <button class="filter-btn active" data-filter="Todos">
        <span>Todos</span>
        <span class="count">{totalConquistas}</span>
      </button>
      
      <!-- Categorias -->
      {contagem.map(tipo => (
        <button class="filter-btn" data-filter={tipo.id}>
          {tipo.icon ? (
            <img src={tipo.icon} alt={tipo.label} width="16" height="16" class="inline-block mr-1 align-middle"/>
          ) : null}
          <span>{tipo.label}</span>
          <span class="count">{tipo.total}</span>
        </button>
      ))}
    </div>
  </section>

  <!-- Filtros Estado -->
  <section class="px-6 md:px-20 pb-6 ">
    <div id="filtros-conquistas-estado" class="flex flex-wrap gap-4 gap-y-1 overflow-x-auto scrollbar-hide py-2">
      <!-- Todos -->
      <button class="filter-btn active" data-filter="Todos">
        <span>Todos</span>
        <span class="count">{totalConquistas}</span>
      </button>
      
      <!-- Categorias -->
      {contagemEstado.map(estado => (
        <button class="filter-btn" data-filter={estado.id}>
          <span>{estado.label}</span>
          <span class="count">{estado.total}</span>
        </button>
      ))}
    </div>
  </section>

  <!-- Lista -->
  <section class="px-6 md:px-20 pb-16">
    <ul id="conquistas-lista" class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-9xl">
      {conquistas.map(c => (
        <li data-tipo={c.type} data-estado={c.state}>
          <CardConquista c={c} />
        </li>
      ))}  
    </ul>
  </section>
</BaseLayout>

<!-- JS m√≠nimo -->
<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const tipoButtons = document.querySelectorAll("#filtros-conquistas .filter-btn");
    const estadoButtons = document.querySelectorAll("#filtros-conquistas-estado .filter-btn");
    const items = document.querySelectorAll("#conquistas-lista li");

    let tipoAtivo = "Todos";
    let estadoAtivo = "Todos";

    tipoButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tipoButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        tipoAtivo = btn.getAttribute("data-filter");
        filtrar();
        atualizarContadores();
      });
    });

    estadoButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        estadoButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        estadoAtivo = btn.getAttribute("data-filter");
        filtrar();
        atualizarContadores();
      });
    });

    function filtrar() {
      items.forEach(item => {
        const tipo = item.getAttribute("data-tipo") || "Sem tipo";
        const estado = item.getAttribute("data-estado") || "Sem estado";
        const tipoOk = tipoAtivo === "Todos" || tipo === tipoAtivo;
        const estadoOk = estadoAtivo === "Todos" || estado === estadoAtivo;
        item.style.display = tipoOk && estadoOk ? "block" : "none";
      });
    }

    function atualizarContadores() {
      // Atualiza contadores dos tipos
      tipoButtons.forEach(btn => {
        const tipo = btn.getAttribute("data-filter");
        let count = 0;
        items.forEach(item => {
          const itemTipo = item.getAttribute("data-tipo") || "Sem tipo";
          const itemEstado = item.getAttribute("data-estado") || "Sem estado";
          const estadoOk = estadoAtivo === "Todos" || itemEstado === estadoAtivo;
          if ((tipo === "Todos" || itemTipo === tipo) && estadoOk) {
            count++;
          }
        });
        const span = btn.querySelector(".count");
        if (span) span.textContent = count;
      });

      // Atualiza contadores dos estados
      estadoButtons.forEach(btn => {
        const estado = btn.getAttribute("data-filter");
        let count = 0;
        items.forEach(item => {
          const itemTipo = item.getAttribute("data-tipo") || "Sem tipo";
          const itemEstado = item.getAttribute("data-estado") || "Sem estado";
          const tipoOk = tipoAtivo === "Todos" || itemTipo === tipoAtivo;
          if ((estado === "Todos" || itemEstado === estado) && tipoOk) {
            count++;
          }
        });
        const span = btn.querySelector(".count");
        if (span) span.textContent = count;
      });
    }

    // Inicializa contadores corretos ao carregar
    atualizarContadores();
  });
</script>