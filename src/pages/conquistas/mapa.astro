---
import BaseLayout from "../../layouts/BaseLayout.astro";
import conquistas from "../../data/conquistas";

const pontos = conquistas.map(c => ({
  name: c.name,
  slug: c.slug,
  type: c.type_achievement,
  lat: c.lat,
  lng: c.lng,
  image: c.imagem,
  sourceLat: c.latSource ?? null,
  sourceLng: c.lngSource ?? null,
  targetLat: c.latTarget ?? null,
  targetLng: c.lngTarget ?? null,
}));
---

<BaseLayout>
  <section class="px-6 md:px-20 py-12">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-4xl font-serif">Mapa das Conquistas</h1>
      <a
        href="/conquistas"
        class="flex items-center gap-2 border border-neutral-700 px-4 py-2 rounded-full hover:border-neutral-400 hover:text-white transition text-base"
      >
        ← Voltar para lista
      </a>
    </div>

    <div
      id="map"
      class="w-full h-[75vh] min-h-125 rounded-2xl border border-neutral-800"
      data-pontos={JSON.stringify(pontos)}
      style="min-height:500px;"
    ></div>
  </section>
</BaseLayout>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  defer
></script>

<script is:inline>
  window.addEventListener("DOMContentLoaded", () => {
    const mapEl = document.getElementById("map");
    if (!mapEl || !window.L) return;

    const pontos = JSON.parse(mapEl.dataset.pontos);

    const map = L.map("map");
    // Ajusta o view para mostrar todos os pontos se houver
    const bounds = [];
    pontos.forEach(p => {
      if (p.lat && p.lng) {
        bounds.push([parseFloat(p.lat), parseFloat(p.lng)]);
      }
    });
    if (bounds.length > 0) {
      map.fitBounds(bounds);
    } else {
      map.setView([-29.5, -51.5], 6);
    }

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap",
    }).addTo(map);

    pontos.forEach(p => {
      if (!p.lat || !p.lng) return;
      const lat = parseFloat(p.lat);
      const lng = parseFloat(p.lng);
      const sourceLat = p.sourceLat ? parseFloat(p.sourceLat) : null;
      const sourceLng = p.sourceLng ? parseFloat(p.sourceLng) : null;
      const targetLat = p.targetLat ? parseFloat(p.targetLat) : null;
      const targetLng = p.targetLng ? parseFloat(p.targetLng) : null;

      // Usa a imagem svg como ícone do marcador
      let icon = undefined;
      if (p.image) {
        icon = L.icon({
          iconUrl: p.image,
          iconSize: [24, 24],
          iconAnchor: [12, 24],
          popupAnchor: [0, -24],
        });
      }

      // Ponto principal
      L.marker([lat, lng], icon ? { icon } : undefined)
        .addTo(map)
        .bindPopup(
          `<strong>${p.name}</strong><br/>
           <a href="/conquistas/${p.slug}">ver detalhes</a>`
        );

      // Ponto Origem
      if (sourceLat && sourceLng) {
        L.marker([sourceLat, sourceLng], { icon: L.icon({ iconUrl: "/source-marker.png", iconSize: [24, 24] }) })
          .addTo(map)
          .bindPopup("Origem");
      }

      // Ponto Destino
      if (targetLat && targetLng) {
        L.marker([targetLat, targetLng], { icon: L.icon({ iconUrl: "/target-marker.png", iconSize: [24, 24] }) })
          .addTo(map)
          .bindPopup("Destino");
      }

      // Linha entre origem e destino
      if (sourceLat && sourceLng && targetLat && targetLng) {
        // Inclui o ponto principal entre origem e destino
        const routePoints = [[sourceLat, sourceLng]];
        if (lat && lng) routePoints.push([lat, lng]);
        routePoints.push([targetLat, targetLng]);

        fetch(`https://router.project-osrm.org/route/v1/driving/${sourceLng},${sourceLat};${lng},${lat};${targetLng},${targetLat}?overview=full&geometries=geojson`)
          .then(res => res.json())
          .then(data => {
            if (data.routes && data.routes[0]) {
              const coords = data.routes[0].geometry.coordinates.map(([lng, lat]) => [lat, lng]);
              L.polyline(coords, { color: "red", weight: 4 }).addTo(map);
            } else {
              L.polyline(routePoints, { color: "blue", dashArray: "8,8" }).addTo(map);
            }
          })
          .catch((err) => {
            L.polyline(routePoints, { color: "green", dashArray: "8,8" }).addTo(map);
            console.error("Erro ao calcular rota OSRM:", err);
          });
      }
    });
  });
</script>
