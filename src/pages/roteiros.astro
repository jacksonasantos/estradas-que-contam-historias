---
import BaseLayout from "../layouts/BaseLayout.astro";
import roteiros from "../data/roteiros";
import RoteiroCard from "../components/RoteiroCard.astro";
import { CATEGORIAS } from "../data/categorias";

const categorias = [...new Set(roteiros.map(r => r.categoria))];
const categoriasCount = roteiros.reduce<Record<string, number>>(
  (acc, roteiro) => {
    acc[roteiro.categoria] = (acc[roteiro.categoria] || 0) + 1;
    return acc;
  },
  {}
);
// Alimenta categoriaLabels e categoriaIcons a partir de CATEGORIAS
const categoriaLabels = Object.fromEntries(
  CATEGORIAS.map(cat => [cat.id, cat.label])
);
const categoriaIcons = Object.fromEntries(
  CATEGORIAS.map(cat => [cat.id, cat.icon])
);
---

<BaseLayout>
  <div class="relative">
    <img
      src="/hero.png"
      alt="Marca d'água"
      class="fixed inset-0 w-full h-full object-cover opacity-20 pointer-events-none z-0"
      style="top:0;left:0;"
    />
    <div class="relative z-10">
      <!-- Cabeçalho -->
      <section class="px-6 md:px-20 py-12 max-w-4xl">
        <h1 class="text-5xl font-serif mb-6">Roteiros</h1>
        <p class="text-neutral-400 text-lg">
          Viagens de moto organizadas por tipo de experiência.
          Escolha a estrada que mais conversa com você.
        </p>
      </section>

      <!-- Filtro -->
      <section class="px-6 md:px-20 pb-16">
        <div class="flex gap-3 flex-wrap">
          <button class="filter-btn active" data-filter="Todos">
            Todos ({roteiros.length})
          </button>
          {categorias.map(cat => {
            const label = categoriaLabels[cat] ?? cat;
            const iconPath = categoriaIcons[cat];
            return (
              <button
                class="filter-btn flex items-center gap-2"
                data-filter={cat}
              >
                <img src={iconPath} alt={label} width="16" height="16" class="inline-block mr-1 align-middle" style="filter: invert(80%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(90%) contrast(90%);"/> 
                <span>{label} ({categoriasCount[cat] || 0})</span>
              </button>
            );
          })}
        </div>
      </section>

      <!-- Lista -->
      <section class="px-6 md:px-20 pb-16">
        <ul
          id="roteiros-lista"
          class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-9xl"
        >
          {roteiros.map(r => (
            <li data-categoria={r.categoria ?? "Sem categoria"}>
              <RoteiroCard roteiro={r} />
            </li>
          ))}
        </ul>
      </section>
    </div>
  </div>
</BaseLayout>

<!-- JS mínimo -->
<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".filter-btn");
    const items = document.querySelectorAll("#roteiros-lista li");

    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        buttons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const filter = btn.getAttribute("data-filter");

        items.forEach(item => {
          const categoria = item.getAttribute("data-categoria") || "Sem categoria";

          item.style.display =
            filter === "Todos" || categoria === filter
              ? "block"
              : "none";
        });
      });
    });
  });
</script>