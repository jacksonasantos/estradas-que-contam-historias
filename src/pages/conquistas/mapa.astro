---
import BaseLayout from "../../layouts/BaseLayout.astro";
import conquistas from "../../data/conquistas";

const pontos = conquistas.map(c => ({
  name: c.name,
  slug: c.slug,
  type: c.type_achievement,
  lat: c.lat,
  lng: c.lng,
  image: c.imagem,
  sourceLat: c.latSource ?? null,
  sourceLng: c.lngSource ?? null,
  targetLat: c.latTarget ?? null,
  targetLng: c.lngTarget ?? null,
}));
---

<BaseLayout>
  <section class="px-6 md:px-20 py-12">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-4xl font-serif">Mapa das Conquistas</h1>
      <a
        href="/conquistas"
        class="flex items-center gap-2 border border-neutral-700 px-4 py-2 rounded-full hover:border-neutral-400 hover:text-white transition text-base"
      >
        ← Voltar para lista
      </a>
    </div>

    <div
      id="map"
      class="w-full h-[75vh] min-h-125 rounded-2xl border border-neutral-800"
      data-pontos={JSON.stringify(pontos)}
      style="min-height:500px;"
    ></div>
  </section>
</BaseLayout>

<!-- Google Maps API -->
<script
  src={`https://maps.googleapis.com/maps/api/js?key=AIzaSyBfMIuonO9FrmxGdK8M8_953tcy_2o5X5M&callback=initMap`}
  async
  defer
></script>

<script is:inline>
  window.initMap = function () {
    const mapEl = document.getElementById("map");
    if (!mapEl) return;

    const pontos = JSON.parse(mapEl.dataset.pontos);

    // Filtra pontos válidos para bounds
    const bounds = new google.maps.LatLngBounds();
    pontos.forEach(p => {
      if (p.lat && p.lng) {
        bounds.extend({ lat: parseFloat(p.lat), lng: parseFloat(p.lng) });
      }
    });

    const map = new google.maps.Map(mapEl, {
      center: bounds.isEmpty() ? { lat: -29.5, lng: -51.5 } : bounds.getCenter(),
      zoom: 6,
      mapTypeId: "roadmap",
      streetViewControl: false,
      fullscreenControl: false,
    });

    if (!bounds.isEmpty()) map.fitBounds(bounds);

    // Crie uma única InfoWindow para reutilizar
    const infoWindow = new google.maps.InfoWindow();

    pontos.forEach(p => {
      if (!p.lat || !p.lng) return;
      const lat = parseFloat(p.lat);
      const lng = parseFloat(p.lng);
      const sourceLat = p.sourceLat ? parseFloat(p.sourceLat) : null;
      const sourceLng = p.sourceLng ? parseFloat(p.sourceLng) : null;
      const targetLat = p.targetLat ? parseFloat(p.targetLat) : null;
      const targetLng = p.targetLng ? parseFloat(p.targetLng) : null;

      // Ícone personalizado
      let icon = undefined;
      if (p.image) {
        icon = {
          url: p.image,
          scaledSize: new google.maps.Size(24, 24),
          anchor: new google.maps.Point(12, 24),
        };
      }

      // Marcador principal
      const marker = new google.maps.Marker({
        position: { lat, lng },
        map,
        icon,
        title: p.name,
      });

      marker.addListener("click", () => {
        infoWindow.setContent(
          `<strong style="color:#333333">${p.name}</strong><br/>
           <a href="/conquistas/${p.slug}" style="color:#666666">ver detalhes</a>`
        );
        infoWindow.open(map, marker);
      });

      // Marcador origem
      if (sourceLat && sourceLng) {
        const sourceMarker = new google.maps.Marker({
          position: { lat: sourceLat, lng: sourceLng },
          map,
          title: "Origem",
          icon: {
            url: "/source-marker.png",
            scaledSize: new google.maps.Size(24, 24),
          },
        });
        sourceMarker.addListener("click", () => {
          infoWindow.setContent(`<span style="color:#222">Origem: ${p.name}</span>`);
          infoWindow.open(map, sourceMarker);
        });
      }

      // Marcador destino
      if (targetLat && targetLng) {
        const targetMarker = new google.maps.Marker({
          position: { lat: targetLat, lng: targetLng },
          map,
          title: "Destino",
          icon: {
            url: "/target-marker.png",
            scaledSize: new google.maps.Size(24, 24),
          },
        });
        targetMarker.addListener("click", () => {
          infoWindow.setContent(`<span style="color:#222">Destino: ${p.name}</span>`);
          infoWindow.open(map, targetMarker);
        });
      }

      // Traçar rota entre origem e destino
      if (sourceLat && sourceLng && targetLat && targetLng) {
        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer({
          map,
          suppressMarkers: true,
          polylineOptions: { strokeColor: "#d00", strokeWeight: 3 }
        });

        const waypoints = [];
        if (lat && lng) {
          waypoints.push({
            location: { lat, lng },
            stopover: true,
          });
        }

        directionsService.route(
          {
            origin: { lat: sourceLat, lng: sourceLng },
            destination: { lat: targetLat, lng: targetLng },
            waypoints,
            travelMode: google.maps.TravelMode.DRIVING,
          },
          (result, status) => {
            if (status === "OK") {
              directionsRenderer.setDirections(result);
            } else {
              // fallback: desenha linha simples
              const routePoints = [
                { lat: sourceLat, lng: sourceLng },
                ...(lat && lng ? [{ lat, lng }] : []),
                { lat: targetLat, lng: targetLng }
              ];
              new google.maps.Polyline({
                path: routePoints,
                map,
                strokeColor: "#0a0",
                strokeOpacity: 0.7,
                strokeWeight: 4,
                icons: [{
                  icon: { path: "M 0,-1 0,1", strokeOpacity: 1, scale: 3 },
                  offset: "0",
                  repeat: "20px"
                }]
              });
            }
          }
        );
      }
    });
  };
</script>
